#cloud-config
# Cloud-init script for bastion host

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - vim
  - openssh-client
  - jq
  - kubectl

write_files:
  - path: /home/ubuntu/.ssh/config
    content: |
      Host *
        StrictHostKeyChecking no
        UserKnownHostsFile /dev/null
    owner: ubuntu:ubuntu
    permissions: '0600'

runcmd:
  # Install kubectl
  - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
  - chmod +x kubectl
  - mv kubectl /usr/local/bin/

  # Create helper script
  - |
    cat > /home/ubuntu/k8s-helpers.sh << 'EOF'
    #!/bin/bash
    # Helper functions for Kubernetes cluster management
    
    export CLUSTER_NAME="${cluster_name}"
    
    # Function to connect to master nodes
    k8s-master() {
      local node_num=${1:-1}
      ssh -i ~/.ssh/${CLUSTER_NAME}-key.pem ubuntu@$(terraform output -json master_nodes | jq -r ".master-${node_num}.private_ip")
    }
    
    # Function to connect to worker nodes
    k8s-worker() {
      local node_num=${1:-1}
      ssh -i ~/.ssh/${CLUSTER_NAME}-key.pem ubuntu@$(terraform output -json worker_nodes | jq -r ".worker-${node_num}.private_ip")
    }
    
    # Function to get kubeconfig
    k8s-config() {
      scp -i ~/.ssh/${CLUSTER_NAME}-key.pem ubuntu@$(terraform output -json master_nodes | jq -r ".master-1.private_ip"):~/.kube/config ~/.kube/config
      chmod 600 ~/.kube/config
    }
    
    echo "Helper functions loaded. Use: k8s-master [1-3], k8s-worker [1-N], k8s-config"
    EOF

  - chmod +x /home/ubuntu/k8s-helpers.sh
  - chown ubuntu:ubuntu /home/ubuntu/k8s-helpers.sh

  # Create .kube directory
  - mkdir -p /home/ubuntu/.kube
  - chown ubuntu:ubuntu /home/ubuntu/.kube

final_message: "Bastion host configured. Use k8s-helpers.sh for cluster management."

