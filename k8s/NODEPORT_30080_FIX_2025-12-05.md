# NodePort 30080 Connection Refused - Fix Guide

**‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:** ‡ß´ ‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞, ‡ß®‡ß¶‡ß®‡ß´  
**‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:** Frontend pod working (Nginx port 80), but NodePort 30080 connection refused  
**‡¶ï‡¶æ‡¶∞‡¶£:** kube-proxy issue ‡¶¨‡¶æ service configuration problem

---

## üîç Current Status

‚úÖ **Working:**
- Frontend pods running (Nginx on port 80)
- Container responding: `curl http://localhost:80` works
- Service created: `dhakacart-frontend-service` (NodePort)

‚ùå **Not Working:**
- NodePort 30080: Connection refused
- ALB: 502 Bad Gateway

---

## ‚úÖ Solutions

### Solution 1: Recreate Service (Quick Fix)

```bash
# Delete and recreate service
kubectl delete svc dhakacart-frontend-service -n dhakacart
kubectl apply -f k8s/services/services.yaml -n dhakacart

# Verify
kubectl get svc -n dhakacart dhakacart-frontend-service
```

### Solution 2: Check kube-proxy

```bash
# Check kube-proxy pods
kubectl get pods -n kube-system -l k8s-app=kube-proxy

# Check kube-proxy logs
kubectl logs -n kube-system -l k8s-app=kube-proxy --tail=50

# Restart kube-proxy (if needed)
kubectl delete pods -n kube-system -l k8s-app=kube-proxy
```

### Solution 3: Verify Service Endpoints

```bash
# Check endpoints
kubectl get endpoints -n dhakacart dhakacart-frontend-service

# Should show pod IPs:
# NAME                        ENDPOINTS
# dhakacart-frontend-service  10.244.2.8:80,10.244.3.7:80

# If empty, check service selector matches pod labels
kubectl get svc -n dhakacart dhakacart-frontend-service -o yaml | grep selector
kubectl get pods -n dhakacart -l app=dhakacart-frontend --show-labels
```

### Solution 4: Test Service from Inside Cluster

```bash
# Test service DNS
kubectl run test-svc --rm -i --tty --image=curlimages/curl --restart=Never -- \
  curl -I http://dhakacart-frontend-service.dhakacart.svc.cluster.local

# Should return HTTP 200
```

### Solution 5: Check iptables Rules (on Worker Node)

SSH to a worker node and check:

```bash
# On worker node
sudo iptables -t nat -L | grep 30080
sudo iptables -t nat -L KUBE-SERVICES | grep 30080

# Should show rules for port 30080
```

### Solution 6: Verify NodePort Range

```bash
# Check kube-apiserver configuration
# NodePort range should be 30000-32767 (default)

# On master node
sudo cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep service-node-port-range

# Or check if custom range is set
```

---

## üîß Quick Diagnostic Commands

```bash
# 1. Service details
kubectl get svc -n dhakacart dhakacart-frontend-service -o yaml

# 2. Endpoints
kubectl get endpoints -n dhakacart dhakacart-frontend-service

# 3. Test from pod
kubectl exec -n dhakacart <pod-name> -- curl -I http://dhakacart-frontend-service.dhakacart.svc.cluster.local

# 4. Check NodePort on service
kubectl get svc -n dhakacart dhakacart-frontend-service -o jsonpath='{.spec.ports[0].nodePort}'
# Should output: 30080

# 5. Test NodePort from master
curl -v http://<worker-node-ip>:30080
```

---

## üéØ Most Likely Fix

**Recreate the service:**

```bash
# Apply service again (forces recreation)
kubectl apply -f k8s/services/services.yaml -n dhakacart --force

# Wait a few seconds
sleep 5

# Test again
curl http://<worker-node-ip>:30080
```

---

## üìã Verification Checklist

After fix:

- [ ] Service shows NodePort 30080
- [ ] Endpoints show pod IPs
- [ ] Service DNS works from inside cluster
- [ ] NodePort accessible from nodes
- [ ] ALB target group shows healthy
- [ ] ALB URL works (no 502)

---

## üêõ If Still Not Working

### Check Security Groups

```bash
# Verify security groups allow port 30080
# AWS Console ‚Üí EC2 ‚Üí Security Groups ‚Üí k8s-nodes-sg
# Should have: Port 30000-32767 from ALB security group
```

### Check ALB Target Group

```bash
# Verify target group is pointing to port 30080
# AWS Console ‚Üí EC2 ‚Üí Target Groups
# Health check should be on port 30080
```

### Alternative: Use Port Forward for Testing

```bash
# If NodePort doesn't work, use port forward
kubectl port-forward -n dhakacart svc/dhakacart-frontend-service 8080:80

# Test
curl http://localhost:8080
```

---

## üìö Related Files

- `k8s/services/services.yaml` - Service definition
- `k8s/check-nodeport.sh` - Diagnostic script

---

**Status:** Active Issue  
**Priority:** High  
**Last Updated:** ‡ß´ ‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞, ‡ß®‡ß¶‡ß®‡ß´

